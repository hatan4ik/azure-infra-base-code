parameters:
- name: slug
  type: string
- name: location
  type: string
- name: containers
  type: string
- name: enablePE
  type: boolean
  default: true

steps:
- task: AzureCLI@2
  displayName: "Per-customer storage + containers + diag + RBAC + PE"
  inputs:
    azureSubscription: '$(OIDC_SERVICE_CONNECTION)'
    scriptType: bash
    scriptLocation: inlineScript
    failOnStandardError: false
    inlineScript: |
      set -euo pipefail

      # === Corrected customer-storage (separate PEs for blob and dfs to avoid OnlyOneGroupIdPermitted) ===

      subId="$(az account show --query id -o tsv)"
      rgName="rg-example-data-${{ parameters.slug }}"
      location="${{ parameters.location }}"
      containers="${{ parameters.containers }}"
      customer="${{ parameters.slug }}"

      # Tags
      declare -a TAGS=(
        "BusinessUnit=data"
        "Environment=$(TAG_Environment)"
        "Owner=$(TAG_Owner)"
        "CostCenter=$(TAG_CostCenter)"
        "System=example-data"
        "Project=$(TAG_Project)"
        "Lifecycle=$(TAG_Lifecycle)"
        "Contact=$(TAG_Contact)"
      )
      tag_merge() { local rid="$1"; shift; az resource tag --ids "$rid" --is-incremental --only-show-errors --tags "$@" >/dev/null; }

      echo ">> RG"
      if ! az group show -n "$rgName" >/dev/null 2>&1; then
        az group create -n "$rgName" -l "$location" --tags "${TAGS[@]}" -o none
      else
        tag_merge "/subscriptions/${subId}/resourceGroups/${rgName}" "${TAGS[@]}"
      fi

      echo ">> ADLS Gen2 SA"
      prefix="st${customer}"
      existing="$(az storage account list -g "$rgName" --query "[?starts_with(name, '${prefix}')].name | [0]" -o tsv)"
      if [[ -n "$existing" ]]; then sa="$existing"; else suf="$(tr -dc 'a-f0-9' </dev/urandom | head -c6)"; sa="${prefix}${suf:0:6}"; fi
      if ! az storage account show -g "$rgName" -n "$sa" >/dev/null 2>&1; then
        az storage account create -g "$rgName" -n "$sa" -l "$location" \
          --sku Standard_LRS --kind StorageV2 --hns true \
          --min-tls-version TLS1_2 --https-only true --allow-blob-public-access false \
          --tags "${TAGS[@]}" -o none
      else
        saId="$(az storage account show -g "$rgName" -n "$sa" --query id -o tsv)"
        tag_merge "$saId" "${TAGS[@]}"
      fi
      saId="$(az storage account show -g "$rgName" -n "$sa" --query id -o tsv)"
      hnsEnabled="$(az storage account show -g "$rgName" -n "$sa" --query isHnsEnabled -o tsv)"

      echo ">> Containers"
      IFS=',' read -r -a CONTS <<< "$containers"
      for c in "${CONTS[@]}"; do
        name="$(echo "$c" | xargs)"; [[ -z "$name" ]] && continue
        az storage container create --name "$name" --account-name "$sa" --auth-mode login --public-access off -o none >/dev/null
      done

      echo ">> Diag to LAW (if present)"
      if [[ -n "$(LAW_NAME)" ]]; then
        LAW_ID="$(az monitor log-analytics workspace show -g "$(LAW_RG)" -n "$(LAW_NAME)" --query id -o tsv 2>/dev/null || true)"
        if [[ -n "$LAW_ID" ]]; then
          cats="$(az monitor diagnostic-settings categories list --resource "$saId" 2>/dev/null || echo '{}')"
          logs="[]"; metrics="[]"
          echo "$cats" | jq -e '.value[] | select(.type=="Log" and .name=="AuditEvent")' >/dev/null 2>&1 && logs='[{"category":"AuditEvent","enabled":true}]'
          echo "$cats" | jq -e '.value[] | select(.type=="Metric" and .name=="AllMetrics")' >/dev/null 2>&1 && metrics='[{"category":"AllMetrics","enabled":true}]'
          if az monitor diagnostic-settings list --resource "$saId" -o tsv --query "value[?name=='ds-sa'].name" | grep -q .; then
            az monitor diagnostic-settings update --name ds-sa --resource "$saId" --workspace "$LAW_ID" --logs "$logs" --metrics "$metrics" >/dev/null
          else
            az monitor diagnostic-settings create --name ds-sa --resource "$saId" --workspace "$LAW_ID" --logs "$logs" --metrics "$metrics" >/dev/null 2>&1 || \
            az monitor diagnostic-settings create --name ds-sa --resource "$saId" --workspace "$LAW_ID" --logs "$logs" --metrics "$metrics" >/dev/null
          fi
        fi
      fi

      echo ">> Harden blob service (HNS-aware)"
      if [[ "$hnsEnabled" == "true" ]]; then
        az storage account blob-service-properties update -g "$rgName" -n "$sa" --enable-delete-retention true --delete-retention-days 30 -o none
      else
        az storage account blob-service-properties update -g "$rgName" -n "$sa" \
          --enable-delete-retention true --delete-retention-days 30 \
          --enable-versioning true --enable-container-delete-retention true --container-delete-retention-days 7 -o none
      fi

      echo ">> RBAC for MI on SA"
      MI_PID="$(az identity show -g "$(MI_RESOURCE_GROUP)" -n "$(MI_NAME)" --query principalId -o tsv 2>/dev/null || true)"
      if [[ -n "$MI_PID" ]]; then
        az role assignment list --assignee-object-id "$MI_PID" --scope "$saId" --query "[?roleDefinitionName=='Storage Blob Data Contributor']|[0]" -o tsv | grep -q . \
          || az role assignment create --assignee-object-id "$MI_PID" --role "Storage Blob Data Contributor" --scope "$saId" -o none 2>/dev/null || echo "   ! RBAC create failed"
      fi

      if [[ "${{ parameters.enablePE }}" == "true" ]]; then
        echo ">> Private Endpoints (separate) to avoid OnlyOneGroupIdPermitted"
        SUBNET_ID="/subscriptions/${subId}/resourceGroups/$(NET_RG)/providers/Microsoft.Network/virtualNetworks/$(VNET_NAME)/subnets/$(SNET_PE_NAME)"
        ZONE_BLOB_ID="/subscriptions/${subId}/resourceGroups/$(NET_RG)/providers/Microsoft.Network/privateDnsZones/$(Z_BLOB)"
        ZONE_DFS_ID="/subscriptions/${subId}/resourceGroups/$(NET_RG)/providers/Microsoft.Network/privateDnsZones/$(Z_DFS)"

        # blob PE
        if ! az network private-endpoint show -g "$rgName" -n "pe-${sa}-blob" >/dev/null 2>&1; then
          az network private-endpoint create -g "$rgName" -n "pe-${sa}-blob" -l "$location" \
            --subnet "$SUBNET_ID" --private-connection-resource-id "$saId" \
            --group-ids blob --connection-name "conn-${sa}-blob" --tags "${TAGS[@]}" -o none
        fi
        if ! az network private-endpoint dns-zone-group show -g "$rgName" --endpoint-name "pe-${sa}-blob" -n "dzg-${sa}-blob" >/dev/null 2>&1; then
          az network private-endpoint dns-zone-group create -g "$rgName" --endpoint-name "pe-${sa}-blob" -n "dzg-${sa}-blob" --private-dns-zone "$ZONE_BLOB_ID" -o none
        fi

        # dfs PE (only if HNS)
        if [[ "$hnsEnabled" == "true" ]]; then
          if ! az network private-endpoint show -g "$rgName" -n "pe-${sa}-dfs" >/dev/null 2>&1; then
            az network private-endpoint create -g "$rgName" -n "pe-${sa}-dfs" -l "$location" \
              --subnet "$SUBNET_ID" --private-connection-resource-id "$saId" \
              --group-ids dfs --connection-name "conn-${sa}-dfs" --tags "${TAGS[@]}" -o none
          fi
          if ! az network private-endpoint dns-zone-group show -g "$rgName" --endpoint-name "pe-${sa}-dfs" -n "dzg-${sa}-dfs" >/dev/null 2>&1; then
            az network private-endpoint dns-zone-group create -g "$rgName" --endpoint-name "pe-${sa}-dfs" -n "dzg-${sa}-dfs" --private-dns-zone "$ZONE_DFS_ID" -o none
          fi
        fi
      else
        echo ">> Storage PE disabled for ${customer}"
      fi

      echo ">> Verification"
      echo "   SA: ${sa} (RG=${rgName}, HNS=${hnsEnabled})"
      az storage container list --account-name "$sa" --auth-mode login --query "[].name" -o tsv | sed 's/^/     - /' || true
      if [[ "${{ parameters.enablePE }}" == "true" ]]; then
        az network private-endpoint list -g "$rgName" --query "[].name" -o tsv | sed 's/^/     - PE: /' || true
      fi

      echo "âœ“ Customer '${customer}' storage ensured."
