parameters:
  - name: image
    type: string

steps:
- bash: |
    set -euo pipefail
    echo "Installing cosign..."
    COSIGN_VERSION=v2.2.4
    curl -sL https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64 -o cosign
    chmod +x cosign && sudo mv cosign /usr/local/bin/
  displayName: 'Install cosign'

# You can fetch the signing key from Key Vault here using AzureKeyVault@2
# and expose COSIGN_PASSWORD and COSIGN_PRIVATE_KEY variables.
- bash: |
    set -euo pipefail
    echo "Signing ${{ parameters.image }}"
    echo "$COSIGN_PRIVATE_KEY" > cosign.key
    cosign sign --key cosign.key ${{ parameters.image }}
  displayName: 'Cosign sign image'
  env:
    COSIGN_PRIVATE_KEY: $(COSIGN_PRIVATE_KEY)
    COSIGN_PASSWORD: $(COSIGN_PASSWORD)
